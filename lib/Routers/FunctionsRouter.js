"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FunctionsRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _middlewares = require("../middlewares");

var _StatusHandler = require("../StatusHandler");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = require("../logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// FunctionsRouter.js
var Parse = require('parse/node').Parse,
    triggers = require('../triggers');

// $JMJ: UPDATED
exports.REPLACE_CRASH_ERRORS_WITH_MESSAGE = true;

function parseObject(obj) {
  if (Array.isArray(obj)) {
    return obj.map(item => {
      return parseObject(item);
    });
  } else if (obj && obj.__type == 'Date') {
    return Object.assign(new Date(obj.iso), obj);
  } else if (obj && obj.__type == 'File') {
    return Parse.File.fromJSON(obj);
  } else if (obj && typeof obj === 'object') {
    return parseParams(obj);
  } else {
    return obj;
  }
}

function parseParams(params) {
  return _lodash.default.mapValues(params, parseObject);
}

class FunctionsRouter extends _PromiseRouter.default {
  mountRoutes() {
    this.route('POST', '/functions/:functionName', _middlewares.promiseEnsureIdempotency, FunctionsRouter.handleCloudFunction);
    this.route('POST', '/jobs/:jobName', _middlewares.promiseEnsureIdempotency, _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
    this.route('POST', '/jobs', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
  }

  static handleCloudJob(req) {
    const jobName = req.params.jobName || req.body.jobName;
    const applicationId = req.config.applicationId;
    const jobHandler = (0, _StatusHandler.jobStatusHandler)(req.config);
    const jobFunction = triggers.getJob(jobName, applicationId);

    if (!jobFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, 'Invalid job.');
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      jobName,
      message: jobHandler.setMessage.bind(jobHandler)
    };
    return jobHandler.setRunning(jobName, params).then(jobStatus => {
      request.jobId = jobStatus.objectId; // run the function async

      process.nextTick(() => {
        Promise.resolve().then(() => {
          return jobFunction(request);
        }).then(result => {
          jobHandler.setSucceeded(result);
        }, error => {
          jobHandler.setFailed(error); // $JMJ: modified
          // Use handler defined in $error.js

          if (global.HandleJobError) {
            global.HandleJobError(jobName, params, error);
          }
        });
      });
      return {
        headers: {
          'X-Parse-Job-Status-Id': jobStatus.objectId
        },
        response: {}
      };
    });
  }

  static createResponseObject(userString
  /* $JMJ: Modified in fork. */
  , resolve, reject) {
    return {
      success: function (result) {
        resolve({
          response: {
            result: Parse._encode(result)
          }
        });
      },
      error: function (message) {
        // $JMJ: Modified in fork.
        if (message instanceof Error) {
          if (message instanceof global.CloudError) {
            message = message.message;
          } else {
            // Use handler defined in $error.js
            if (global.HandleServerCrash) {
              global.HandleServerCrash(message.stack, userString);
            }

            const isParseError = message instanceof Parse.Error;

            if (!isParseError && exports.REPLACE_CRASH_ERRORS_WITH_MESSAGE) {
              // Replace crash error message for clients.
              message = 'Something went wrong. Please try again or contact support.';
            } else {
              message = message.message;
            }
          }
        }

        const error = triggers.resolveError(message);
        reject(error);
      }
    };
  }

  static handleCloudFunction(req) {
    const functionName = req.params.functionName;
    const applicationId = req.config.applicationId;
    const theFunction = triggers.getFunction(functionName, applicationId);

    if (!theFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, `Invalid function: "${functionName}"`);
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      master: req.auth && req.auth.isMaster,
      user: req.auth && req.auth.user,
      installationId: req.info.installationId,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      functionName,
      context: req.info.context
    };
    return new Promise(function (resolve, reject) {
      const userString = req.auth && req.auth.user ? req.auth.user.id : undefined;

      const cleanInput = _logger.logger.truncateLogMessage(JSON.stringify(params));

      const {
        success,
        error
      } = FunctionsRouter.createResponseObject(userString
      /* $JMJ: Modified in fork. */
      , result => {
        try {
          const cleanResult = _logger.logger.truncateLogMessage(JSON.stringify(result.response.result));

          _logger.logger.info(`Ran cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Result: ${cleanResult}`, {
            functionName,
            params,
            user: userString
          });

          resolve(result);
        } catch (e) {
          reject(e);
        }
      }, error => {
        try {
          _logger.logger.error(`Failed running cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Error: ` + JSON.stringify(error), {
            functionName,
            error,
            params,
            user: userString
          });

          reject(error); // $JMJ: modified
          // Use handler defined in $error.js

          if (global.HandleCloudFunctionError) {
            global.HandleCloudFunctionError(functionName, params, error, userString);
          }
        } catch (e) {
          reject(e);
        }
      });
      return Promise.resolve().then(() => {
        return triggers.maybeRunValidator(request, functionName, req.auth);
      }).then(() => {
        return theFunction(request);
      }).then(success, error);
    });
  }

}

exports.FunctionsRouter = FunctionsRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0Z1bmN0aW9uc1JvdXRlci5qcyJdLCJuYW1lcyI6WyJQYXJzZSIsInJlcXVpcmUiLCJ0cmlnZ2VycyIsImV4cG9ydHMiLCJSRVBMQUNFX0NSQVNIX0VSUk9SU19XSVRIX01FU1NBR0UiLCJwYXJzZU9iamVjdCIsIm9iaiIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsIml0ZW0iLCJfX3R5cGUiLCJPYmplY3QiLCJhc3NpZ24iLCJEYXRlIiwiaXNvIiwiRmlsZSIsImZyb21KU09OIiwicGFyc2VQYXJhbXMiLCJwYXJhbXMiLCJfIiwibWFwVmFsdWVzIiwiRnVuY3Rpb25zUm91dGVyIiwiUHJvbWlzZVJvdXRlciIsIm1vdW50Um91dGVzIiwicm91dGUiLCJwcm9taXNlRW5zdXJlSWRlbXBvdGVuY3kiLCJoYW5kbGVDbG91ZEZ1bmN0aW9uIiwicHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiLCJyZXEiLCJoYW5kbGVDbG91ZEpvYiIsImpvYk5hbWUiLCJib2R5IiwiYXBwbGljYXRpb25JZCIsImNvbmZpZyIsImpvYkhhbmRsZXIiLCJqb2JGdW5jdGlvbiIsImdldEpvYiIsIkVycm9yIiwiU0NSSVBUX0ZBSUxFRCIsInF1ZXJ5IiwicmVxdWVzdCIsImxvZyIsImxvZ2dlckNvbnRyb2xsZXIiLCJoZWFkZXJzIiwiaXAiLCJtZXNzYWdlIiwic2V0TWVzc2FnZSIsImJpbmQiLCJzZXRSdW5uaW5nIiwidGhlbiIsImpvYlN0YXR1cyIsImpvYklkIiwib2JqZWN0SWQiLCJwcm9jZXNzIiwibmV4dFRpY2siLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlc3VsdCIsInNldFN1Y2NlZWRlZCIsImVycm9yIiwic2V0RmFpbGVkIiwiZ2xvYmFsIiwiSGFuZGxlSm9iRXJyb3IiLCJyZXNwb25zZSIsImNyZWF0ZVJlc3BvbnNlT2JqZWN0IiwidXNlclN0cmluZyIsInJlamVjdCIsInN1Y2Nlc3MiLCJfZW5jb2RlIiwiQ2xvdWRFcnJvciIsIkhhbmRsZVNlcnZlckNyYXNoIiwic3RhY2siLCJpc1BhcnNlRXJyb3IiLCJyZXNvbHZlRXJyb3IiLCJmdW5jdGlvbk5hbWUiLCJ0aGVGdW5jdGlvbiIsImdldEZ1bmN0aW9uIiwibWFzdGVyIiwiYXV0aCIsImlzTWFzdGVyIiwidXNlciIsImluc3RhbGxhdGlvbklkIiwiaW5mbyIsImNvbnRleHQiLCJpZCIsInVuZGVmaW5lZCIsImNsZWFuSW5wdXQiLCJsb2dnZXIiLCJ0cnVuY2F0ZUxvZ01lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwiY2xlYW5SZXN1bHQiLCJlIiwiSGFuZGxlQ2xvdWRGdW5jdGlvbkVycm9yIiwibWF5YmVSdW5WYWxpZGF0b3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFDQTs7OztBQVpBO0FBRUEsSUFBSUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUFQLENBQXNCRCxLQUFsQztBQUFBLElBQ0VFLFFBQVEsR0FBR0QsT0FBTyxDQUFDLGFBQUQsQ0FEcEI7O0FBWUE7QUFDQUUsT0FBTyxDQUFDQyxpQ0FBUixHQUE0QyxJQUE1Qzs7QUFFQSxTQUFTQyxXQUFULENBQXFCQyxHQUFyQixFQUEwQjtBQUN4QixNQUFJQyxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsR0FBZCxDQUFKLEVBQXdCO0FBQ3RCLFdBQU9BLEdBQUcsQ0FBQ0csR0FBSixDQUFRQyxJQUFJLElBQUk7QUFDckIsYUFBT0wsV0FBVyxDQUFDSyxJQUFELENBQWxCO0FBQ0QsS0FGTSxDQUFQO0FBR0QsR0FKRCxNQUlPLElBQUlKLEdBQUcsSUFBSUEsR0FBRyxDQUFDSyxNQUFKLElBQWMsTUFBekIsRUFBaUM7QUFDdEMsV0FBT0MsTUFBTSxDQUFDQyxNQUFQLENBQWMsSUFBSUMsSUFBSixDQUFTUixHQUFHLENBQUNTLEdBQWIsQ0FBZCxFQUFpQ1QsR0FBakMsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJQSxHQUFHLElBQUlBLEdBQUcsQ0FBQ0ssTUFBSixJQUFjLE1BQXpCLEVB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QUFDQyxPQUFSLEdBQ0pQLElBREksQ0FDQyxNQUFNO0FBQ1YsZUFBT2hELFFBQVEsQ0FBQzZGLGlCQUFULENBQTJCdEQsT0FBM0IsRUFBb0NrQyxZQUFwQyxFQUFrRDlDLEdBQUcsQ0FBQ2tELElBQXRELENBQVA7QUFDRCxPQUhJLEVBSUo3QixJQUpJLENBSUMsTUFBTTtBQUNWLGVBQU8wQixXQUFXLENBQUNuQyxPQUFELENBQWxCO0FBQ0QsT0FOSSxFQU9KUyxJQVBJLENBT0NrQixPQVBELEVBT1VSLEtBUFYsQ0FBUDtBQVFELEtBMURNLENBQVA7QUEyREQ7O0FBbk1nRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZ1bmN0aW9uc1JvdXRlci5qc1xuXG52YXIgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJykuUGFyc2UsXG4gIHRyaWdnZXJzID0gcmVxdWlyZSgnLi4vdHJpZ2dlcnMnKTtcblxuaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQge1xuICBwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgcHJvbWlzZUVuc3VyZUlkZW1wb3RlbmN5LFxufSBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgeyBqb2JTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcblxuLy8gJEpNSjogVVBEQVRFRFxuZXhwb3J0cy5SRVBMQUNFX0NSQVNIX0VSUk9SU19XSVRIX01FU1NBR0UgPSB0cnVlO1xuXG5mdW5jdGlvbiBwYXJzZU9iamVjdChvYmopIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkge1xuICAgIHJldHVybiBvYmoubWFwKGl0ZW0gPT4ge1xuICAgICAgcmV0dXJuIHBhcnNlT2JqZWN0KGl0ZW0pO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKG9iaiAmJiBvYmouX190eXBlID09ICdEYXRlJykge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyBEYXRlKG9iai5pc28pLCBvYmopO1xuICB9IGVsc2UgaWYgKG9iaiAmJiBvYmouX190eXBlID09ICdGaWxlJykge1xuICAgIHJldHVybiBQYXJzZS5GaWxlLmZyb21KU09OKG9iaik7XG4gIH0gZWxzZSBpZiAob2JqICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7XG4gICAgcmV0dXJuIHBhcnNlUGFyYW1zKG9iaik7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG9iajtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVBhcmFtcyhwYXJhbXMpIHtcbiAgcmV0dXJuIF8ubWFwVmFsdWVzKHBhcmFtcywgcGFyc2VPYmplY3QpO1xufVxuXG5leHBvcnQgY2xhc3MgRnVuY3Rpb25zUm91dGVyIGV4dGVuZHMgUHJvbWlzZVJvdXRlciB7XG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoXG4gICAgICAnUE9TVCcsXG4gICAgICAnL2Z1bmN0aW9ucy86ZnVuY3Rpb25OYW1lJyxcbiAgICAgIHByb21pc2VFbnN1cmVJZGVtcG90ZW5jeSxcbiAgICAgIEZ1bmN0aW9uc1JvdXRlci5oYW5kbGVDbG91ZEZ1bmN0aW9uXG4gICAgKTtcbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BPU1QnLFxuICAgICAgJy9qb2JzLzpqb2JOYW1lJyxcbiAgICAgIHByb21pc2VFbnN1cmVJZGVtcG90ZW5jeSxcbiAgICAgIHByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLFxuICAgICAgZnVuY3Rpb24gKHJlcSkge1xuICAgICAgICByZXR1cm4gRnVuY3Rpb25zUm91dGVyLmhhbmRsZUNsb3VkSm9iKHJlcSk7XG4gICAgICB9XG4gICAgKTtcbiAgICB0aGlzLnJvdXRlKCdQT1NUJywgJy9qb2JzJywgcHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIGZ1bmN0aW9uIChyZXEpIHtcbiAgICAgIHJldHVybiBGdW5jdGlvbnNSb3V0ZXIuaGFuZGxlQ2xvdWRKb2IocmVxKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXRpYyBoYW5kbGVDbG91ZEpvYihyZXEpIHtcbiAgICBjb25zdCBqb2JOYW1lID0gcmVxLnBhcmFtcy5qb2JOYW1lIHx8IHJlcS5ib2R5LmpvYk5hbWU7XG4gICAgY29uc3QgYXBwbGljYXRpb25JZCA9IHJlcS5jb25maWcuYXBwbGljYXRpb25JZDtcbiAgICBjb25zdCBqb2JIYW5kbGVyID0gam9iU3RhdHVzSGFuZGxlcihyZXEuY29uZmlnKTtcbiAgICBjb25zdCBqb2JGdW5jdGlvbiA9IHRyaWdnZXJzLmdldEpvYihqb2JOYW1lLCBhcHBsaWNhdGlvbklkKTtcbiAgICBpZiAoIWpvYkZ1bmN0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuU0NSSVBUX0ZBSUxFRCwgJ0ludmFsaWQgam9iLicpO1xuICAgIH1cbiAgICBsZXQgcGFyYW1zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxLmJvZHksIHJlcS5xdWVyeSk7XG4gICAgcGFyYW1zID0gcGFyc2VQYXJhbXMocGFyYW1zKTtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgcGFyYW1zOiBwYXJhbXMsXG4gICAgICBsb2c6IHJlcS5jb25maWcubG9nZ2VyQ29udHJvbGxlcixcbiAgICAgIGhlYWRlcnM6IHJlcS5jb25maWcuaGVhZGVycyxcbiAgICAgIGlwOiByZXEuY29uZmlnLmlwLFxuICAgICAgam9iTmFtZSxcbiAgICAgIG1lc3NhZ2U6IGpvYkhhbmRsZXIuc2V0TWVzc2FnZS5iaW5kKGpvYkhhbmRsZXIpLFxuICAgIH07XG5cbiAgICByZXR1cm4gam9iSGFuZGxlci5zZXRSdW5uaW5nKGpvYk5hbWUsIHBhcmFtcykudGhlbihqb2JTdGF0dXMgPT4ge1xuICAgICAgcmVxdWVzdC5qb2JJZCA9IGpvYlN0YXR1cy5vYmplY3RJZDtcbiAgICAgIC8vIHJ1biB0aGUgZnVuY3Rpb24gYXN5bmNcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBqb2JGdW5jdGlvbihyZXF1ZXN0KTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgam9iSGFuZGxlci5zZXRTdWNjZWVkZWQocmVzdWx0KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIGpvYkhhbmRsZXIuc2V0RmFpbGVkKGVycm9yKTtcblxuICAgICAgICAgICAgICAvLyAkSk1KOiBtb2RpZmllZFxuICAgICAgICAgICAgICAvLyBVc2UgaGFuZGxlciBkZWZpbmVkIGluICRlcnJvci5qc1xuICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkhhbmRsZUpvYkVycm9yKSB7XG4gICAgICAgICAgICAgICAgZ2xvYmFsLkhhbmRsZUpvYkVycm9yKGpvYk5hbWUsIHBhcmFtcywgZXJyb3IpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdYLVBhcnNlLUpvYi1TdGF0dXMtSWQnOiBqb2JTdGF0dXMub2JqZWN0SWQsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc3BvbnNlOiB7fSxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgY3JlYXRlUmVzcG9uc2VPYmplY3QoXG4gICAgdXNlclN0cmluZyAvKiAkSk1KOiBNb2RpZmllZCBpbiBmb3JrLiAqLyxcbiAgICByZXNvbHZlLFxuICAgIHJlamVjdCxcbiAgKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHJlc3VsdDogUGFyc2UuX2VuY29kZShyZXN1bHQpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiBmdW5jdGlvbiAobWVzc2FnZSkge1xuXG4gICAgICAgIC8vICRKTUo6IE1vZGlmaWVkIGluIGZvcmsuXG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IpIHtcblxuICAgICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgZ2xvYmFsLkNsb3VkRXJyb3IpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFVzZSBoYW5kbGVyIGRlZmluZWQgaW4gJGVycm9yLmpzXG4gICAgICAgICAgICBpZiAoZ2xvYmFsLkhhbmRsZVNlcnZlckNyYXNoKSB7XG4gICAgICAgICAgICAgIGdsb2JhbC5IYW5kbGVTZXJ2ZXJDcmFzaChtZXNzYWdlLnN0YWNrLCB1c2VyU3RyaW5nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgaXNQYXJzZUVycm9yID0gbWVzc2FnZSBpbnN0YW5jZW9mIFBhcnNlLkVycm9yO1xuICAgICAgICAgICAgaWYgKCFpc1BhcnNlRXJyb3IgJiYgZXhwb3J0cy5SRVBMQUNFX0NSQVNIX0VSUk9SU19XSVRIX01FU1NBR0UpIHtcbiAgICAgICAgICAgICAgLy8gUmVwbGFjZSBjcmFzaCBlcnJvciBtZXNzYWdlIGZvciBjbGllbnRzLlxuICAgICAgICAgICAgICBtZXNzYWdlID0gJ1NvbWV0aGluZyB3ZW50IHdyb25nLiBQbGVhc2UgdHJ5IGFnYWluIG9yIGNvbnRhY3Qgc3VwcG9ydC4nO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlcnJvciA9IHRyaWdnZXJzLnJlc29sdmVFcnJvcihtZXNzYWdlKTtcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuICBzdGF0aWMgaGFuZGxlQ2xvdWRGdW5jdGlvbihyZXEpIHtcbiAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSByZXEucGFyYW1zLmZ1bmN0aW9uTmFtZTtcbiAgICBjb25zdCBhcHBsaWNhdGlvbklkID0gcmVxLmNvbmZpZy5hcHBsaWNhdGlvbklkO1xuICAgIGNvbnN0IHRoZUZ1bmN0aW9uID0gdHJpZ2dlcnMuZ2V0RnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBhcHBsaWNhdGlvbklkKTtcblxuICAgIGlmICghdGhlRnVuY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5TQ1JJUFRfRkFJTEVELCBgSW52YWxpZCBmdW5jdGlvbjogXCIke2Z1bmN0aW9uTmFtZX1cImApO1xuICAgIH1cbiAgICBsZXQgcGFyYW1zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxLmJvZHksIHJlcS5xdWVyeSk7XG4gICAgcGFyYW1zID0gcGFyc2VQYXJhbXMocGFyYW1zKTtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgcGFyYW1zOiBwYXJhbXMsXG4gICAgICBtYXN0ZXI6IHJlcS5hdXRoICYmIHJlcS5hdXRoLmlzTWFzdGVyLFxuICAgICAgdXNlcjogcmVxLmF1dGggJiYgcmVxLmF1dGgudXNlcixcbiAgICAgIGluc3RhbGxhdGlvbklkOiByZXEuaW5mby5pbnN0YWxsYXRpb25JZCxcbiAgICAgIGxvZzogcmVxLmNvbmZpZy5sb2dnZXJDb250cm9sbGVyLFxuICAgICAgaGVhZGVyczogcmVxLmNvbmZpZy5oZWFkZXJzLFxuICAgICAgaXA6IHJlcS5jb25maWcuaXAsXG4gICAgICBmdW5jdGlvbk5hbWUsXG4gICAgICBjb250ZXh0OiByZXEuaW5mby5jb250ZXh0LFxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgY29uc3QgdXNlclN0cmluZyA9IHJlcS5hdXRoICYmIHJlcS5hdXRoLnVzZXIgPyByZXEuYXV0aC51c2VyLmlkIDogdW5kZWZpbmVkO1xuICAgICAgY29uc3QgY2xlYW5JbnB1dCA9IGxvZ2dlci50cnVuY2F0ZUxvZ01lc3NhZ2UoSlNPTi5zdHJpbmdpZnkocGFyYW1zKSk7XG4gICAgICBjb25zdCB7IHN1Y2Nlc3MsIGVycm9yIH0gPSBGdW5jdGlvbnNSb3V0ZXIuY3JlYXRlUmVzcG9uc2VPYmplY3QoXG4gICAgICAgIHVzZXJTdHJpbmcgLyogJEpNSjogTW9kaWZpZWQgaW4gZm9yay4gKi8sXG4gICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNsZWFuUmVzdWx0ID0gbG9nZ2VyLnRydW5jYXRlTG9nTWVzc2FnZShKU09OLnN0cmluZ2lmeShyZXN1bHQucmVzcG9uc2UucmVzdWx0KSk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICAgICAgYFJhbiBjbG91ZCBmdW5jdGlvbiAke2Z1bmN0aW9uTmFtZX0gZm9yIHVzZXIgJHt1c2VyU3RyaW5nfSB3aXRoOlxcbiAgSW5wdXQ6ICR7Y2xlYW5JbnB1dH1cXG4gIFJlc3VsdDogJHtjbGVhblJlc3VsdH1gLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyU3RyaW5nLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgICBgRmFpbGVkIHJ1bm5pbmcgY2xvdWQgZnVuY3Rpb24gJHtmdW5jdGlvbk5hbWV9IGZvciB1c2VyICR7dXNlclN0cmluZ30gd2l0aDpcXG4gIElucHV0OiAke2NsZWFuSW5wdXR9XFxuICBFcnJvcjogYCArXG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoZXJyb3IpLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyU3RyaW5nLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcblxuICAgICAgICAgICAgLy8gJEpNSjogbW9kaWZpZWRcbiAgICAgICAgICAgIC8vIFVzZSBoYW5kbGVyIGRlZmluZWQgaW4gJGVycm9yLmpzXG4gICAgICAgICAgICBpZiAoZ2xvYmFsLkhhbmRsZUNsb3VkRnVuY3Rpb25FcnJvcikge1xuICAgICAgICAgICAgICBnbG9iYWwuSGFuZGxlQ2xvdWRGdW5jdGlvbkVycm9yKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uTmFtZSxcbiAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgICAgdXNlclN0cmluZ1xuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0cmlnZ2Vycy5tYXliZVJ1blZhbGlkYXRvcihyZXF1ZXN0LCBmdW5jdGlvbk5hbWUsIHJlcS5hdXRoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGVGdW5jdGlvbihyZXF1ZXN0KTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oc3VjY2VzcywgZXJyb3IpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=